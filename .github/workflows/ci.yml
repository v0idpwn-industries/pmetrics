name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        postgres: [17]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install PostgreSQL ${{ matrix.postgres }}
        run: |
          # Add PostgreSQL APT repository
          sudo apt-get update
          sudo apt-get install -y curl ca-certificates
          sudo install -d /usr/share/postgresql-common/pgdg
          sudo curl -o /usr/share/postgresql-common/pgdg/apt.postgresql.org.asc --fail https://www.postgresql.org/media/keys/ACCC4CF8.asc
          sudo sh -c 'echo "deb [signed-by=/usr/share/postgresql-common/pgdg/apt.postgresql.org.asc] https://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          sudo apt-get update

          # Install PostgreSQL
          sudo apt-get install -y postgresql-${{ matrix.postgres }} postgresql-server-dev-${{ matrix.postgres }}

      - name: Build and install pmetrics
        run: |
          PG_CONFIG=/usr/lib/postgresql/${{ matrix.postgres }}/bin/pg_config make clean
          PG_CONFIG=/usr/lib/postgresql/${{ matrix.postgres }}/bin/pg_config make pmetrics.all
          sudo PG_CONFIG=/usr/lib/postgresql/${{ matrix.postgres }}/bin/pg_config make pmetrics.install
          PG_CONFIG=/usr/lib/postgresql/${{ matrix.postgres }}/bin/pg_config make pmetrics_stmts.all
          sudo PG_CONFIG=/usr/lib/postgresql/${{ matrix.postgres }}/bin/pg_config make pmetrics_stmts.install
        env:
          USE_PGXS: 1

      - name: Configure and start PostgreSQL
        run: |
          # Create PostgreSQL cluster using Debian/Ubuntu tools
          sudo pg_createcluster ${{ matrix.postgres }} main --start

          # Configure PostgreSQL (PGC_POSTMASTER settings require restart)
          PG_CONF=/etc/postgresql/${{ matrix.postgres }}/main/postgresql.conf
          echo "shared_preload_libraries = 'pmetrics,pmetrics_stmts'" | sudo tee -a "$PG_CONF"
          echo "compute_query_id = on" | sudo tee -a "$PG_CONF"
          echo "port = 5433" | sudo tee -a "$PG_CONF"
          echo "max_connections = 300" | sudo tee -a "$PG_CONF"

          # Restart PostgreSQL to apply PGC_POSTMASTER settings
          sudo systemctl restart postgresql@${{ matrix.postgres }}-main

          # Wait for PostgreSQL to be ready
          for i in {1..30}; do
            if sudo -u postgres psql -p 5433 -c "SELECT 1" >/dev/null 2>&1; then
              echo "PostgreSQL is ready"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "ERROR: PostgreSQL failed to start after 30 seconds"
              echo "=== systemd logs ==="
              sudo journalctl -u postgresql@17-main --no-pager -n 50
              echo "=== PostgreSQL error logs ==="
              sudo tail -100 /var/log/postgresql/postgresql-17-main.log
              exit 1
            fi
            echo "Waiting for PostgreSQL to be ready... ($i/30)"
            sleep 1
          done

          # Verify extensions are loaded
          echo "Checking loaded extensions..."
          sudo -u postgres psql -p 5433 -c "SHOW shared_preload_libraries;"

          # Set up database
          sudo -u postgres psql -p 5433 -c "ALTER USER postgres PASSWORD 'postgres';"
          sudo -u postgres psql -p 5433 -c "CREATE DATABASE demo;"

      - name: Set up Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: '1.17'
          otp-version: '27'

      - name: Install Elixir dependencies
        working-directory: ./test
        run: |
          mix local.hex --force
          mix local.rebar --force
          mix deps.get

      - name: Run Elixir tests
        working-directory: ./test
        run: mix test
        env:
          PGHOST: localhost
          PGPORT: 5433
          PGUSER: postgres
          PGPASSWORD: postgres
          PGDATABASE: demo

  format:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install clang-format
        run: sudo apt-get update && sudo apt-get install -y clang-format

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Set up Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: '1.17'
          otp-version: '27'

      - name: Install Elixir dependencies for formatting
        working-directory: ./test
        run: |
          mix local.hex --force
          mix local.rebar --force

      - name: Check formatting
        run: |
          make format
          if ! git diff --exit-code; then
            echo "Code is not formatted. Please run 'make format'"
            exit 1
          fi
